<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App</title>
</head>

<body>
  <h1>One-on-One Chat App</h1>

  <label for="usernameInput">Your Name:</label>
  <input type="text" id="usernameInput" placeholder="Enter your username" />

  <label for="recipientInput">Send To:</label>
  <input type="text" id="recipientInput" placeholder="Recipient username" />

  <!-- Chat message input -->
  <input type="text" id="messageInput" placeholder="Type your message..." />
  <button id="sendButton">Send</button>

  <!-- Chat messages display area -->
  <div id="chatBox"></div>

  <script>
    let sock;
    let username;

    const usernameInput = document.getElementById("usernameInput");
    const recipientInput = document.getElementById("recipientInput");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const chatBox = document.getElementById("chatBox");

    // Start connection only when username is entered
    usernameInput.addEventListener("change", function () {
      username = usernameInput.value;

      // Connect to WebSocket server
      sock = new WebSocket("ws://localhost:8080/ws");

      sock.onopen = () => {
        console.log("WebSocket connected");

        // Send login message: from=username, to="", content=""
        const loginMsg = {
          from: username,
          to: "",
          content: "LOGIN",
          timestamp: new Date().toISOString()
        };

        sock.send(JSON.stringify(loginMsg));
      };

      sock.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const p = document.createElement("p");
        p.textContent = `${msg.from} → you: ${msg.content}`;
        chatBox.appendChild(p);
      };
    });

    sendButton.addEventListener("click", function () {
      const message = messageInput.value;
      const recipient = recipientInput.value;

      if (!message || !recipient || !username) {
        alert("Please enter all fields: username, recipient, and message.");
        return;
      }

      const msg = {
        from: username,
        to: recipient,
        content: message,
        timestamp: new Date().toISOString()
      };

      sock.send(JSON.stringify(msg));

      // Show your own message
      const p = document.createElement("p");
      p.textContent = `You → ${recipient}: ${message}`;
      chatBox.appendChild(p);
      messageInput.value = "";
    });
  </script>
</body>

</html>