<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App</title>
  <style>
    .hidden {
      display: none;
    }
    #userList li {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h1>One-on-One Chat App</h1>

  <div id="authSection">
    <div id="toggleLinks">
      <button id="showLogin">Login</button>
      <button id="showRegister">Register</button>
    </div>

    <div id="loginForm">
      <h2>Login</h2>
      <input type="text" id="loginUsername" placeholder="Username"/><br/>
      <input type="password" id="loginPassword" placeholder="Password"/><br/>
      <button id="loginButton">Login</button>
    </div>

    <div id="registerForm" class="hidden">
      <h2>Register</h2>
      <form>
        <input type="text" id="regUsername" placeholder="Username"/><br/>
        <input type="password" id="regPassword" placeholder="Password"/><br/>
        <button id="registerButton">Register</button>
      </form>
    </div>
  </div>

  <div id="chatSection" class="hidden">
    <h2>Welcome, <span id="currentUser"></span></h2>

    <div id="userListContainer">
      <h3>Users</h3>
      <ul id="userList"></ul>
    </div>

    <input type="text" id="messageInput" placeholder="Type a message..."/>
    <button id="sendButton">Send</button>

    <div id="chatBox"></div>
  </div>

  <script>
    let sock;
    let currentUser = "";
    let selectedRecipient = null;

    const showLoginForm = () => {
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("registerForm").classList.add("hidden");
    };

    const showRegisterForm = () => {
      document.getElementById("registerForm").classList.remove("hidden");
      document.getElementById("loginForm").classList.add("hidden");
    };

    document.getElementById("showLogin").onclick = showLoginForm;
    document.getElementById("showRegister").onclick = showRegisterForm;

    document.getElementById("registerButton").onclick = async () => {
      const username = document.getElementById("regUsername").value;
      const password = document.getElementById("regPassword").value;

      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      alert(data.message);
    };

    document.getElementById("loginButton").onclick = async () => {
      const username = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();

      if (data.success) {
        currentUser = username;
        localStorage.setItem("chat_user", username); // store session
        startChat();
      } else {
        alert(data.message);
      }
    };

    function startChat() {
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("chatSection").classList.remove("hidden");
      document.getElementById("currentUser").textContent = currentUser;
      connectWebSocket();
      loadUsers();
    }

    function connectWebSocket() {
      sock = new WebSocket("ws://localhost:8080/ws");

      sock.onopen = () => {
        sock.send(JSON.stringify({
          from: currentUser,
          to: "",
          content: "",
          timestamp: new Date().toISOString()
        }));
        console.log("WebSocket connected.");
      };

      sock.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const p = document.createElement("p");
        p.textContent = msg.from + ": " + msg.content;
        document.getElementById("chatBox").appendChild(p);
      };
    }

    document.getElementById("sendButton").onclick = () => {
      const content = document.getElementById("messageInput").value;

      if (!selectedRecipient || !content) {
        alert("Select a user and type a message.");
        return;
      }

      const msg = {
        from: currentUser,
        to: selectedRecipient,
        content: content,
        timestamp: new Date().toISOString()
      };

      sock.send(JSON.stringify(msg));

      const p = document.createElement("p");
      p.textContent = "You to " + selectedRecipient + ": " + content;
      document.getElementById("chatBox").appendChild(p);

      document.getElementById("messageInput").value = "";
    };

    async function loadUsers() {
      const res = await fetch("/users");
      const users = await res.json();
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      users.forEach(user => {
        if (user.username === currentUser) return;

        const li = document.createElement("li");
        li.textContent = `${user.username} - ${user.status}`;
        li.onclick = () => {
          selectedRecipient = user.username;
          alert("Now chatting with " + selectedRecipient);
        };
        userList.appendChild(li);
      });
    }

    // session check
    window.onload = () => {
      const savedUser = localStorage.getItem("chat_user");
      if (savedUser) {
        currentUser = savedUser;
        startChat();
      }
    };
  </script>
</body>

</html>
